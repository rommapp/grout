name: Create Beta Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.3.0 - without v prefix or beta suffix)'
        required: true
        type: string
      changelog:
        description: 'Changelog message for this beta release'
        required: false
        type: string
        default: 'Beta release for testing'

permissions:
  contents: write

jobs:
  beta-release:
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine build number
        id: build_number
        run: |
          VERSION="${{ inputs.version }}"

          # Get all tags matching this version's beta releases
          git fetch --tags
          EXISTING_TAGS=$(git tag -l "v${VERSION}-beta.*" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            BUILD_NUM=1
          else
            # Get the highest build number
            LAST_TAG=$(echo "$EXISTING_TAGS" | tail -1)
            LAST_BUILD=$(echo "$LAST_TAG" | sed -n 's/.*-beta\.\([0-9]*\).*/\1/p')
            BUILD_NUM=$((LAST_BUILD + 1))
          fi

          FULL_VERSION="v${VERSION}-beta.${BUILD_NUM}"
          echo "build_number=${BUILD_NUM}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Creating beta release: ${FULL_VERSION}"

      - name: Update pak.json for beta
        run: |
          BETA_VERSION="${{ steps.build_number.outputs.full_version }}"

          # Update root pak.json
          jq --arg version "$BETA_VERSION" \
             --arg changelog "${{ inputs.changelog }}" \
             '.version = $version | .changelog[$version] = $changelog' \
             pak.json > pak.json.tmp && mv pak.json.tmp pak.json

          echo "Updated pak.json to version: $BETA_VERSION"
          cat pak.json

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Package
        run: task build extract package-next package-muos package-knulli

      - name: Create NextUI distribution
        run: |
          cd build/Grout.pak
          zip -r ../Grout-${{ steps.build_number.outputs.full_version }}.pak.zip .

      - name: Create muOS distribution
        run: |
          cd build/muOS
          zip -r Grout.muxapp Grout
          mv Grout.muxapp ../Grout-${{ steps.build_number.outputs.full_version }}.muxapp

      - name: Create Knulli distribution
        run: |
          cd build/Knulli
          zip -r ../Grout-${{ steps.build_number.outputs.full_version }}-Knulli.zip Grout

      - name: Generate changelog content
        id: changelog
        run: |
          CHANGELOG="${{ inputs.changelog }}"
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Beta release for testing - Build ${{ steps.build_number.outputs.build_number }}"
          fi

          # Add beta warning using heredoc
          cat <<EOF >> $GITHUB_OUTPUT
          changelog<<CHANGELOG_EOF
          âš ï¸ **This is a pre-release beta build from the dev branch**

          This build may contain bugs and is intended for testing purposes only.

          **Beta Build #${{ steps.build_number.outputs.build_number }}**

          ${CHANGELOG}

          ---

          Built from commit: \`${GITHUB_SHA:0:7}\`
          Branch: \`dev\`
          CHANGELOG_EOF
          EOF

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build_number.outputs.full_version }}
          name: ${{ steps.build_number.outputs.full_version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            build/Grout-${{ steps.build_number.outputs.full_version }}.pak.zip
            build/Grout-${{ steps.build_number.outputs.full_version }}.muxapp
            build/Grout-${{ steps.build_number.outputs.full_version }}-Knulli.zip
          draft: false
          prerelease: true
          target_commitish: dev
