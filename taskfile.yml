version: '3'

tasks:
  build:
    desc: Build for ARM64 using remote gabagool
    cmds:
      - rm -rf build
      - docker buildx build --platform=linux/arm64 --build-arg GITHUB_ACTIONS=false -t retro-console-arm64 -f Dockerfile .
    silent: true

  build-local:
    desc: Build for ARM64 using local gabagool workspace
    cmds:
      - rm -rf build
      - echo "Building with local gabagool workspace..."
      - cd .. && docker buildx build --platform=linux/arm64 --build-arg USE_LOCAL_GABAGOOL=true --build-arg GITHUB_ACTIONS=false -f grout/Dockerfile -t retro-console-arm64 .
    silent: true

  all:
    desc: Build and package for all platforms
    cmds:
      - task: build
      - task: extract
      - task: package-next
      - task: package-muos
      - task: package-knulli

  all-local:
    desc: Build (with local gabagool via go work) and package for all platforms
    cmds:
      - task: build-local
      - task: extract
      - task: package-next
      - task: package-muos
      - task: muxapp
      - task: package-knulli

  extract:
    desc: Extract binary and libraries from Docker image
    cmds:
      - mkdir -p build
      - mkdir -p build/lib
      - docker rm extract || true
      - docker create --name extract retro-console-arm64
      - docker cp extract:/build/grout build/grout
      - docker cp extract:/usr/lib/aarch64-linux-gnu/libSDL2_gfx-1.0.so.0.0.2 build/lib/libSDL2_gfx-1.0.so.0
    silent: true

  package-next:
    desc: Package for NextUI
    cmds:
      - rm -rf build/Grout.pak || true
      - mkdir -p build/Grout.pak/lib
      - cp build/grout scripts/NextUI/launch.sh README.md LICENSE pak.json build/Grout.pak
      - cp -R build/lib/* build/Grout.pak/lib/
    silent: true

  package-muos:
    desc: Package for muOS
    cmds:
      - rm -rf build/muOS || true
      - mkdir -p build/muOS/Grout/lib
      - cp build/grout scripts/muOS/mux_launch.sh README.md LICENSE build/muOS/Grout
      - cp -R build/lib/* build/muOS/Grout/lib/
    silent: true

  package-knulli:
    desc: Package for Knulli
    cmds:
      - rm -rf build/Knulli || true
      - mkdir -p build/Knulli/Grout/lib
      - cp build/grout scripts/Knulli/Grout.sh README.md LICENSE build/Knulli/Grout
      - cp -R build/lib/* build/Knulli/Grout/lib/
    silent: true

  muxapp:
    desc: Create .muxapp archive for muOS
    cmds:
      - task: package-muos
      - rm -rf build/Grout.muxapp || true
      - cd build/muOS && zip -r ../Grout.muxapp Grout
      - echo "Created build/Grout.muxapp"
    silent: true

  adb-next:
    desc: Deploy to NextUI device via ADB
    cmds:
      - adb shell rm -rf /mnt/SDCARD/Tools/tg5040/Grout.pak || true
      - adb push build/Grout.pak /mnt/SDCARD/Tools/tg5040
      - adb push config-platformless.json /mnt/SDCARD/Tools/tg5040/Grout.pak/config.json
    silent: true

  adb-muos:
    desc: Deploy to muOS device via ADB
    cmds:
      - adb shell rm -rf /mnt/sdcard/MUOS/application/Grout || true
      - adb push build/muOS/Grout /mnt/sdcard/MUOS/application
      - adb push config-platformless.json /mnt/sdcard/MUOS/application/Grout/config.json
    silent: true

  adb-knulli:
    desc: Deploy to Knulli device via ADB
    cmds:
      - adb shell rm -rf /userdata/roms/ports/Grout || true
      - adb push build/Knulli/Grout /userdata/roms/ports
      - adb push config-platformless.json /userdata/roms/ports/Grout/config.json
    silent: true

  mp4-to-webp:
    desc: ffmpeg conversion for mp4 to webp
    interactive: true
    prompt: true
    cmds:
      - |
        read -p "Enter MP4 input path: " INPUT_PATH
        read -p "Enter WEBP output path (e.g., /path/to/output.webp): " OUTPUT_PATH

        # Add .webp extension if not present
        if [[ ! "$OUTPUT_PATH" =~ \.webp$ ]]; then
          OUTPUT_PATH="${OUTPUT_PATH}.webp"
        fi

        ffmpeg -i "$INPUT_PATH" -vcodec libwebp -filter:v fps=fps=20 -lossless 0  -compression_level 3 -q:v 70 -loop 0 -preset picture -an -vsync 0 -s 1024:768 "$OUTPUT_PATH"

  resize-user-guide-images:
    desc: Resize user guide images to 1024px width
    cmds:
      - |
        cd .github/resources/user_guide
        for img in *.png; do
          sips -Z 1024 "$img" --out "$img"
        done
        echo "All user guide images resized to 1024px width"
