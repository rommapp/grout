version: '3'

tasks:
  build:
    desc: Build for ARM64 using remote gabagool
    cmds:
      - rm -rf build
      - docker buildx build --platform=linux/arm64 -t retro-console-arm64 -f Dockerfile .
    silent: true

  build-local:
    desc: Build for ARM64 using local gabagool workspace
    cmds:
      - rm -rf build
      - echo "Building with local gabagool workspace..."
      - cd .. && docker buildx build --platform=linux/arm64 --build-arg USE_LOCAL_GABAGOOL=true -f grout/Dockerfile -t retro-console-arm64 .
    silent: true

  all:
    desc: Build and package for all platforms
    cmds:
      - task: build
      - task: extract
      - task: package-next
      - task: package-muos

  all-local:
    desc: Build (with local gabagool via go work) and package for all platforms
    cmds:
      - task: build-local
      - task: extract
      - task: package-next
      - task: package-muos

  extract:
    desc: Extract binary and libraries from Docker image
    cmds:
      - mkdir -p build
      - mkdir -p build/lib
      - docker rm extract || true
      - docker create --name extract retro-console-arm64
      - docker cp extract:/build/grout build/grout
      - docker cp extract:/usr/lib/aarch64-linux-gnu/libSDL2_gfx-1.0.so.0.0.2 build/lib/libSDL2_gfx-1.0.so.0
    silent: true

  package-next:
    desc: Package for NextUI
    cmds:
      - rm -rf build/Grout.pak || true
      - mkdir -p build/Grout.pak
      - mkdir -p build/Grout.pak/resources/lib
      - cp build/grout scripts/NextUI/launch.sh README.md LICENSE pak.json build/Grout.pak
      - cp -R build/lib build/Grout.pak/resources
      - cp -R resources build/Grout.pak/
    silent: true

  package-muos:
    desc: Package for muOS
    cmds:
      - rm -rf build/muOS || true
      - mkdir -p build/muOS/Grout
      - mkdir -p build/muOS/Grout/resources/lib
      - cp build/grout scripts/muOS/mux_launch.sh README.md LICENSE build/muOS/Grout
      - cp -R build/lib build/muOS/Grout/resources
      - cp -R resources build/muOS/Grout/
      - cp -R fonts build/muOS/Grout/resources
    silent: true

  adb-next:
    desc: Deploy to NextUI device via ADB
    cmds:
      - adb shell rm -rf /mnt/SDCARD/Tools/tg5040/Grout.pak || true
      - adb push build/Grout.pak /mnt/SDCARD/Tools/tg5040
      - adb push config-platformless.json /mnt/SDCARD/Tools/tg5040/Grout.pak/config.json
    silent: true

  adb-muos:
    desc: Deploy to muOS device via ADB
    cmds:
      - adb shell rm -rf /mnt/sdcard/MUOS/application/Grout || true
      - adb push build/muOS/Grout /mnt/sdcard/MUOS/application
      - adb push config-platformless.json /mnt/sdcard/MUOS/application/Grout/config.json
      - adb push .github/resources/input_mappings/muOS/anbernic_mapping.json /mnt/sdcard/MUOS/application/Grout/input_mapping.json
    silent: true
